<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å¤§è—¥åŠ‘éƒ¨ - èª¿åŠ‘è¨“ç·´éŠæˆ²</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'PingFang TC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        /* è—¥æ«ƒä¸»å€åŸŸ */
        .cabinet-area {
            background: #eceff1;
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        /* ========== ä¸­é–“éŠæˆ²å€æ•´åˆæ¨£å¼ ========== */
        .center-game-zone {
            flex: 2;
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border: 3px solid #fbc02d;
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-width: 300px;
        }

        .compact-header {
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            color: #5d4037;
        }

        .version-tag {
            font-size: 0.7rem;
            background: #8d6e63;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 5px;
        }

        .compact-stats {
            display: flex;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .mini-stat {
            display: flex;
            align-items: center;
            gap: 4px;
            background: white;
            padding: 4px 10px;
            border-radius: 15px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stat-label {
            font-size: 0.85rem;
        }

        .stat-val {
            font-weight: bold;
            font-size: 1rem;
        }

        .stat-val.time {
            color: #e74c3c;
        }

        .stat-val.score {
            color: #27ae60;
        }

        .stat-val.combo {
            color: #f39c12;
        }

        .mode-selector-compact {
            display: flex;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .mode-btn-sm {
            padding: 5px 12px;
            border: none;
            border-radius: 15px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .mode-btn-sm.location {
            background: #3498db;
            color: white;
        }

        .mode-btn-sm.dispensing {
            background: #27ae60;
            color: white;
        }

        .mode-btn-sm.rush {
            background: #e74c3c;
            color: white;
        }

        .mode-btn-sm:hover {
            transform: scale(1.05);
        }

        .mode-btn-sm.active {
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }

        .mode-divider {
            color: #ccc;
            margin: 0 5px;
            font-weight: bold;
        }

        .game-ctrl-btn {
            padding: 5px 10px;
            border: none;
            border-radius: 15px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .game-ctrl-btn.pause {
            background: #ff9800;
            color: white;
        }

        .game-ctrl-btn.pause.paused {
            background: #4caf50;
        }

        .game-ctrl-btn.restart {
            background: #9e9e9e;
            color: white;
        }

        .game-ctrl-btn:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }

        .prescription-compact {
            background: white;
            border-radius: 8px;
            padding: 6px 10px;
        }

        .prescription-compact.position-ok {
            outline: 2px solid rgba(76, 175, 80, 0.9);
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.15);
        }

        /* é…è—¥/æ¸¬è©¦æ¨¡å¼ï¼šå°æç¤ºï¼ˆä¸è·³ç½®ä¸­è¦–çª—ï¼‰ */
        .inline-hint {
            margin-top: 6px;
            font-size: 0.8rem;
            font-weight: bold;
            text-align: center;
            padding: 4px 8px;
            border-radius: 6px;
            display: none;
            line-height: 1.2;
        }

        .inline-hint.show {
            display: block;
        }

        .inline-hint.correct {
            color: #2e7d32;
            background: rgba(76, 175, 80, 0.12);
            border: 1px solid rgba(76, 175, 80, 0.45);
        }

        .inline-hint.wrong {
            color: #c62828;
            background: rgba(244, 67, 54, 0.12);
            border: 1px solid rgba(244, 67, 54, 0.45);
        }

        /* æ¡Œé¢å€å¸¸å‚™è—¥ï¼ˆBiocal / Coxine / Sennapur / Loditonï¼‰ */
        .desktop-drug-pool {
            margin-top: 6px;
            background: rgba(255, 255, 255, 0.65);
            border-radius: 8px;
            padding: 6px 8px;
            border: 1px dashed rgba(93, 64, 55, 0.35);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex-wrap: wrap;
        }

        .desktop-drug-pool-label {
            font-size: 0.75rem;
            color: #5d4037;
            font-weight: bold;
            flex: 0 0 auto;
        }

        .desktop-drug-pool-items {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            justify-content: center;
            flex: 0 1 auto;
        }

        .desktop-drug-pool .draggable-drug {
            font-size: 0.7rem;
            padding: 4px 8px;
            cursor: pointer;
        }

        /* å®šä½æ¨¡å¼ï¼šç½®ä¸­é¡¯ç¤º */
        .location-mode-row {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .drug-name-compact {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .drug-hint-compact {
            font-size: 0.75rem;
            color: #666;
        }

        /* é…è—¥æ¨¡å¼ï¼šæ°´å¹³æ’åˆ— */
        .dispensing-mode-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            flex-wrap: nowrap;
            width: 100%;
        }

        .dispensing-mode-row .drug-name-compact {
            flex: 1 1 auto;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quantity-badge {
            background: #e74c3c;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: bold;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        .spec-badge {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            white-space: nowrap;
            flex: 0 0 auto;
        }

        .counter-group {
            display: flex;
            gap: 8px;
            align-items: center;
            flex: 0 0 auto;
        }

        .counter-item {
            display: flex;
            align-items: center;
            gap: 2px;
        }

        .counter-minus {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            border: 1px solid #ccc;
            background: #f5f5f5;
            color: #666;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            line-height: 1;
        }

        .counter-minus:hover {
            background: #e0e0e0;
        }

        .counter-minus:active {
            background: #d0d0d0;
        }

        .counter-circle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            user-select: none;
            transition: all 0.15s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .counter-circle:hover {
            transform: scale(1.1);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        .counter-circle:active {
            transform: scale(0.95);
        }

        .counter-label {
            font-size: 0.7rem;
            color: #555;
            min-width: 14px;
        }

        .submit-btn-sm {
            padding: 6px 12px;
            background: #27ae60;
            color: white;
            border: none;
            border-radius: 15px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-btn-sm:hover {
            background: #219a52;
            transform: scale(1.05);
        }

        .section-label {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 10px;
            text-align: center;
            font-weight: bold;
        }

        /* ========== ä¸Šæ’ï¼šC - B - A é–‹æ”¾å¼æ¶å­ ========== */
        .top-shelf-row {
            display: flex;
            gap: 8px;
            justify-content: stretch;
            align-items: stretch;
            margin-bottom: 15px;
            padding: 0;
            width: 100%;
        }

        .shelf-cabinet {
            background: linear-gradient(180deg, #a1887f 0%, #8d6e63 100%);
            border-radius: 8px;
            padding: 8px;
            flex: 1;
            min-width: 0;
            border: 3px solid #5d4037;
            display: flex;
            flex-direction: column;
        }

        .shelf-cabinet .shelf-grid {
            flex: 1;
            align-content: stretch;
        }

        .shelf-cabinet .cab-label {
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 8px;
            background: #4e342e;
            border-radius: 4px;
            padding: 4px;
            letter-spacing: 2px;
        }

        .shelf-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 3px;
        }

        /* ========== ä¸‹æ’ï¼šJ - I - H - G - E - F æŠ½å±œæ«ƒ ========== */
        .bottom-cabinet-row {
            display: flex;
            gap: 8px;
            justify-content: stretch;
            padding: 0;
            width: 100%;
        }

        .drawer-cabinet {
            background: linear-gradient(180deg, #8d6e63 0%, #6d4c41 100%);
            border-radius: 8px;
            padding: 8px;
            flex: 1;
            min-width: 0;
            border: 3px solid #4e342e;
            display: flex;
            flex-direction: column;
        }

        /* Hover effects for Zoom interaction */
        .shelf-cabinet,
        .drawer-section,
        .door {
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .shelf-cabinet:hover,
        .drawer-section:hover,
        .door:hover {
            transform: scale(1.02);
            box-shadow: 0 0 15px rgba(255, 193, 7, 0.6);
            z-index: 5;
            position: relative;
        }

        /* Continuous Hint Styling */
        .cabinet-hint-active {
            box-shadow: 0 0 0 4px #ffc107, 0 0 20px #ffc107 !important;
            animation: pulse-border 1.5s infinite;
        }

        @keyframes pulse-border {
            0% {
                box-shadow: 0 0 0 4px #ffc107;
            }

            50% {
                box-shadow: 0 0 0 8px rgba(255, 193, 7, 0.5);
            }

            100% {
                box-shadow: 0 0 0 4px #ffc107;
            }
        }

        .drawer-cabinet .cab-label {
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 6px;
            background: #3e2723;
            border-radius: 4px;
            padding: 4px;
            letter-spacing: 2px;
        }

        /* æŠ½å±œå€ (ä¸ŠåŠéƒ¨) */
        .drawer-section {
            margin-bottom: 6px;
        }

        .drawer-label {
            font-size: 0.65rem;
            color: #d7ccc8;
            text-align: center;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .drawer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 4px;
            background: #5d4037;
            padding: 5px;
            border-radius: 5px;
            margin-bottom: 5px;
        }

        /* é›™é–‹é–€å€ (ä¸‹åŠéƒ¨) */
        .door-section {
            display: flex;
            gap: 6px;
        }

        .door {
            flex: 1;
            background: #4e342e;
            border-radius: 5px;
            padding: 5px;
            border: 2px solid #3e2723;
            min-width: 0;
        }

        .door-label {
            font-size: 0.6rem;
            color: #bcaaa4;
            text-align: center;
            margin-bottom: 3px;
            font-weight: bold;
        }

        .door-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3px;
        }

        /* è—¥å“æ ¼å­ */
        .drug-slot {
            background: #efebe9;
            border-radius: 3px;
            min-height: 32px;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            padding: 2px;
            text-align: center;
            color: #333;
            border: 2px solid transparent;
            line-height: 1.15;
            position: relative;
            user-select: none;
        }

        .drug-slot.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .drug-slot:hover {
            background: #bbdefb;
            transform: scale(1.05);
            z-index: 10;
        }

        .drug-slot.correct {
            background: #a5d6a7;
            border-color: #4caf50;
            animation: pulse 0.5s;
        }

        .drug-slot.wrong {
            background: #ef9a9a;
            border-color: #f44336;
            animation: shake 0.5s;
        }

        .drug-slot.highlight {
            background: #fff59d;
            border-color: #ffc107;
            animation: glow 1s infinite;
        }

        .drug-slot.box::after {
            content: 'ç›’';
            font-size: 0.45rem;
            color: #e65100;
            position: absolute;
            bottom: 0;
            right: 1px;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.08);
            }
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-4px);
            }

            75% {
                transform: translateX(4px);
            }
        }

        @keyframes glow {

            0%,
            100% {
                box-shadow: 0 0 5px #ffc107;
            }

            50% {
                box-shadow: 0 0 15px #ffc107;
            }
        }

        /* æ¡Œé¢å€ - å·¥ä½œå€åŸŸ */
        .desktop-area-container {
            display: flex;
            gap: 12px;
            margin: 12px 0;
            padding: 10px;
            background: linear-gradient(180deg, #bcaaa4 0%, #a1887f 100%);
            border-radius: 10px;
            border: 2px solid #8d6e63;
            min-height: 120px;
            align-items: stretch;
        }

        .drop-zone {
            flex: 1;
            min-height: 100px;
            background: #efebe9;
            border-radius: 8px;
            border: 3px dashed #8d6e63;
            padding: 8px;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .drop-zone.drag-over {
            background: #c8e6c9;
            border-color: #4caf50;
            border-style: solid;
        }

        .drop-zone-label {
            font-size: 0.75rem;
            font-weight: bold;
            color: #5d4037;
            margin-bottom: 6px;
            text-align: center;
            padding: 3px 6px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 4px;
        }

        .drop-zone-content {
            flex: 1;
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            align-content: flex-start;
            min-height: 40px;
        }

        .left-hand-zone {
            border-color: #1976d2;
        }

        .left-hand-zone .drop-zone-label {
            color: #1565c0;
        }

        .left-hand-zone.drag-over {
            background: #bbdefb;
            border-color: #1976d2;
        }

        .right-hand-zone {
            border-color: #c62828;
        }

        .right-hand-zone .drop-zone-label {
            color: #c62828;
        }

        .right-hand-zone.drag-over {
            background: #ffcdd2;
            border-color: #c62828;
        }

        .draggable-drug {
            background: linear-gradient(135deg, #fff9c4 0%, #fff59d 100%);
            border: 2px solid #fbc02d;
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.75rem;
            cursor: grab;
            user-select: none;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .draggable-drug:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .draggable-drug.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .draggable-drug.in-left {
            background: linear-gradient(135deg, #bbdefb 0%, #90caf9 100%);
            border-color: #1976d2;
        }

        .draggable-drug.in-right {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%);
            border-color: #c62828;
        }

        /* å›é¥‹è¨Šæ¯ */
        .feedback {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 25px 45px;
            border-radius: 12px;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 1000;
            display: none;
            animation: fadeInOut 1.2s;
        }

        .feedback.correct {
            background: #4caf50;
            color: white;
        }

        .feedback.wrong {
            background: #f44336;
            color: white;
        }

        @keyframes fadeInOut {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }

            20% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }

            80% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        /* é–‹å§‹ç•«é¢ */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .start-screen h1 {
            color: white;
            font-size: 2.5rem;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .start-screen p {
            color: white;
            font-size: 1.1rem;
            margin-bottom: 25px;
            opacity: 0.9;
        }

        .start-btn {
            padding: 18px 50px;
            font-size: 1.3rem;
            background: #fff;
            color: #667eea;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
        }

        .start-btn:hover {
            transform: scale(1.08);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .start-screen.hidden {
            display: none;
        }

        /* çµæœç•«é¢ */
        .result-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .result-screen.active {
            display: flex;
        }

        .result-card {
            background: white;
            padding: 35px;
            border-radius: 15px;
            text-align: center;
            max-width: 420px;
        }

        .result-card h2 {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #333;
        }

        .result-stats p {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: #555;
        }

        .result-stats .highlight {
            color: #27ae60;
            font-weight: bold;
        }

        .retry-btn {
            padding: 12px 35px;
            font-size: 1.1rem;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }

        /* ========== æ”¾å¤§è¦–çª—æ¨£å¼ ========== */
        .zoom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
        }

        .zoom-modal.active {
            display: flex;
        }

        .zoom-content {
            background: white;
            border-radius: 15px;
            padding: 20px;
            max-width: 85%;
            max-height: 85vh;
            overflow: auto;
            position: relative;
        }

        .zoom-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e0e0e0;
        }

        .zoom-title {
            font-size: 1.3rem;
            font-weight: bold;
            color: #333;
        }

        .zoom-close {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            font-size: 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
            flex-shrink: 0;
        }

        .zoom-close:hover {
            background: #c0392b;
        }

        .zoom-grid {
            display: grid;
            gap: 10px;
            margin-top: 12px;
        }

        .zoom-grid.shelf-layout {
            grid-template-columns: repeat(6, 1fr);
        }

        .zoom-grid.drawer-layout {
            grid-template-columns: repeat(3, 1fr);
        }

        .zoom-grid.door-layout {
            grid-template-columns: repeat(2, 1fr);
        }

        .zoom-drug-card {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            border: 2px solid #3498db;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            min-height: 85px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .zoom-drug-card:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .zoom-drug-card.box {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-color: #f39c12;
        }

        .zoom-drug-card.empty {
            background: #ecf0f1;
            border-color: #bdc3c7;
            cursor: default;
        }

        .zoom-drug-card.empty:hover {
            transform: none;
            box-shadow: none;
        }

        .zoom-drug-name {
            font-size: 1rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 6px;
        }

        .zoom-drug-info {
            font-size: 0.8rem;
            color: #7f8c8d;
            line-height: 1.4;
        }

        .zoom-drug-location {
            font-size: 0.75rem;
            color: #3498db;
            margin-top: 4px;
            font-weight: 500;
        }

        .zoom-section-title {
            font-size: 1.1rem;
            margin-bottom: 8px;
            margin-top: 12px;
            color: #2c3e50;
        }

        .zoom-section-title:first-child {
            margin-top: 0;
        }

        /* è®“æ«ƒä½æ¨™ç±¤å’ŒæŠ½å±œæ¨™ç±¤å¯é»æ“Š */
        .cab-label,
        .drawer-label {
            cursor: pointer;
            user-select: none;
            transition: all 0.3s;
        }

        .cab-label:hover,
        .drawer-label:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        .cab-label::after,
        .drawer-label::after {
            content: ' ğŸ”';
            font-size: 0.8em;
            opacity: 0.6;
        }

        /* ========== æç¤ºæ¨¡å¼æ¨£å¼ ========== */
        .hint-controls {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .hint-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .hint-toggle:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .hint-toggle.active {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }

        .show-hint-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .show-hint-btn:hover {
            transform: scale(1.05);
            background: #2980b9;
        }

        .show-hint-btn:disabled {
            background: #95a5a6;
            cursor: not-allowed;
            transform: none;
        }

        /* é–ƒçˆå‹•ç•« */
        @keyframes blink-highlight {

            0%,
            100% {
                background: #f1c40f;
                transform: scale(1);
                box-shadow: 0 0 20px rgba(241, 196, 15, 0.8);
            }

            50% {
                background: #e74c3c;
                transform: scale(1.1);
                box-shadow: 0 0 30px rgba(231, 76, 60, 1);
            }
        }

        .slot-blinking {
            animation: blink-highlight 1s ease-in-out 3;
            z-index: 100;
        }

        /* RWD */
        @media (max-width: 1400px) {
            .drawer-cabinet {
                padding: 6px;
            }

            .door-grid {
                gap: 2px;
            }

            .center-game-zone {
                min-width: 250px;
            }
        }

        @media (max-width: 1200px) {
            .top-shelf-row {
                flex-wrap: wrap;
            }

            .bottom-cabinet-row {
                flex-wrap: wrap;
            }

            .shelf-cabinet {
                flex: 1 1 30%;
                min-width: 280px;
            }

            .drawer-cabinet {
                flex: 1 1 30%;
                min-width: 150px;
            }

            .desktop-area-container {
                flex-direction: column;
            }

            .center-game-zone {
                flex: 1;
                min-width: 100%;
                order: -1;
            }

            .drop-zone {
                min-height: 60px;
            }
        }

        @media (max-width: 900px) {
            .drawer-cabinet {
                flex: 1 1 45%;
            }

            .shelf-cabinet {
                flex: 1 1 45%;
            }
        }

        @media (max-width: 768px) {
            .compact-header {
                font-size: 0.85rem;
            }

            .drug-slot {
                font-size: 0.5rem;
                min-height: 28px;
            }

            .shelf-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .drawer-cabinet {
                flex: 1 1 100%;
            }

            .shelf-cabinet {
                flex: 1 1 100%;
            }

            .desktop-area-container {
                padding: 8px;
                gap: 10px;
            }
        }

        /* Drug Image Styling */
        #drugImageOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 3000;
            cursor: pointer;
            backdrop-filter: blur(2px);
        }

        #drugImageOverlay img {
            max-width: 90%;
            max-height: 80vh;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.5);
            border: 4px solid white;
            object-fit: contain;
            transition: transform 0.2s;
        }

        #drugImageOverlay img:hover {
            transform: scale(1.02);
        }

        /* å³æ‰‹å€è—¥å“åœ–ç‰‡é¡¯ç¤º */
        .drug-image-container {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            width: 100%;
            box-sizing: border-box;
        }

        .drug-image-close {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 50%;
            background: #e74c3c;
            color: white;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .drug-image-close:hover {
            background: #c0392b;
        }

        .drug-image-preview {
            max-width: 100%;
            max-height: 200px;
            object-fit: contain;
            border-radius: 8px;
            border: 2px solid #ddd;
            margin-bottom: 8px;
        }

        .drug-image-name {
            font-weight: bold;
            color: #2c3e50;
            text-align: center;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <!-- é–‹å§‹ç•«é¢ -->
    <div class="start-screen" id="startScreen">
        <h1>ğŸ’Š èª¿åŠ‘è¨“ç·´éŠæˆ²</h1>
        <p>å°å¤§é†«é™¢è—¥åŠ‘éƒ¨ é–€è¨ºé…è—¥ç·´ç¿’</p>
        <button class="start-btn" onclick="startGame()">é–‹å§‹è¨“ç·´</button>
    </div>

    <!-- Result Screen -->
    <div class="result-screen" id="resultScreen">
        <div class="result-card">
            <h2>ğŸ‰ è¨“ç·´å®Œæˆï¼</h2>
            <div class="result-stats">
                <p>ç¸½åˆ†ï¼š<span class="highlight" id="finalScore">0</span> åˆ†</p>
                <p>æ­£ç¢ºç‡ï¼š<span class="highlight" id="finalAccuracy">0</span>%</p>
                <p>æœ€é«˜é€£æ“Šï¼š<span class="highlight" id="finalCombo">0</span></p>
                <p id="errorDrugs"></p>
            </div>
            <button class="retry-btn" onclick="restartGame()">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <!-- Drug Image Overlay -->
    <div id="drugImageOverlay" onclick="toggleDrugImage()">
        <img id="overlayImage" src="" alt="Drug Preview">
    </div>

    <!-- ä¸»éŠæˆ²å€ -->
    <div class="container">
        <div class="cabinet-area">
            <!-- ä¸Šæ’ï¼šC - B - A é–‹æ”¾å¼æ¶å­ -->
            <!-- ä¸Šæ’ï¼šC - B - A é–‹æ”¾å¼æ¶å­ -->
            <div class="top-shelf-row">
                <div class="shelf-cabinet" id="cabinetC"></div>
                <div class="shelf-cabinet" id="cabinetB"></div>
                <div class="shelf-cabinet" id="cabinetA"></div>
            </div>

            <!-- æ¡Œé¢å·¥ä½œå€ - æ•´åˆç‹€æ…‹èˆ‡é¡Œç›® -->
            <div class="desktop-area-container">
                <div class="drop-zone left-hand-zone" id="leftHandZone">
                    <div class="drop-zone-label">ğŸ–¥ï¸ æ¡Œé¢å“é …</div>
                    <!-- Drug Image Removed from here -->
                    <div class="drop-zone-content" id="leftHandContent"></div>
                </div>

                <!-- ä¸­é–“ï¼šéŠæˆ²ç‹€æ…‹èˆ‡é¡Œç›®å€ -->
                <div class="center-game-zone">
                    <div class="compact-header">
                        ğŸ’Š å°å¤§è—¥åŠ‘éƒ¨ èª¿åŠ‘è¨“ç·´ <span class="version-tag">2025/12/17</span>
                    </div>
                    <div class="compact-stats">
                        <div class="mini-stat"><span class="stat-label">â±</span><span class="stat-val time"
                                id="timer">60</span></div>
                        <div class="mini-stat"><span class="stat-label">ğŸ¯</span><span class="stat-val score"
                                id="score">0</span></div>
                        <div class="mini-stat"><span class="stat-label">ğŸ”¥</span><span class="stat-val combo"
                                id="combo">0</span></div>
                        <div class="mini-stat"><span class="stat-label">ğŸ“</span><span class="stat-val"
                                id="questionCount">0/10</span></div>
                    </div>
                    <div class="mode-selector-compact">
                        <button class="mode-btn-sm location active" onclick="setMode('location')">ğŸ—ºï¸ å®šä½</button>
                        <button class="mode-btn-sm dispensing" onclick="setMode('dispensing')">ğŸ’Š é…è—¥</button>
                        <button class="mode-btn-sm rush" onclick="setMode('rush')">âš¡ æ¸¬è©¦</button>
                        <span class="mode-divider">|</span>
                        <button class="game-ctrl-btn pause" id="pauseBtn" onclick="togglePause()" style="display:none;">â¸ï¸ æš«åœ</button>
                        <button class="game-ctrl-btn restart" id="restartBtn" onclick="restartGame()" style="display:none;">ğŸ”„ é‡ä¾†</button>
                    </div>
                    <div class="hint-controls">
                        <button class="hint-toggle" id="hintToggle" onclick="toggleHintMode()">
                            <span id="hintToggleIcon">ğŸ’¡</span>
                            <span id="hintToggleText">æç¤ºæ¨¡å¼ï¼šé—œé–‰</span>
                        </button>
                        <button class="show-hint-btn" id="showHintBtn" onclick="showLocationHint()" disabled>
                            ğŸ¯ é¡¯ç¤ºä½ç½®æç¤º
                        </button>
                    </div>
                    <div class="prescription-compact">
                        <!-- å®šä½æ¨¡å¼ï¼šå–®è¡Œé¡¯ç¤º -->
                        <div class="location-mode-row" id="locationModeRow">
                            <div class="drug-name-compact" id="drugNameLocation">ç­‰å¾…é–‹å§‹...</div>
                            <span class="drug-hint-compact" id="drugHintLocation"></span>
                        </div>
                        <!-- é…è—¥æ¨¡å¼ï¼šæ°´å¹³æ’åˆ—æ‰€æœ‰å…ƒç´  -->
                        <div class="dispensing-mode-row" id="dispensingModeRow" style="display: none;">
                            <div class="drug-name-compact" id="drugNameDispensing">ç­‰å¾…é–‹å§‹...</div>
                            <span class="quantity-badge" id="drugQuantityBadge">Ã—0</span>
                            <span class="spec-badge" id="specBadge">10/ç›’</span>
                            <div class="counter-group">
                                <div class="counter-item">
                                    <button class="counter-minus" onclick="adjustCount('box', -1)">âˆ’</button>
                                    <div class="counter-circle" onclick="adjustCount('box', 1)" id="boxCount">0</div>
                                    <span class="counter-label">ç›’</span>
                                </div>
                                <div class="counter-item">
                                    <button class="counter-minus" onclick="adjustCount('strip', -1)">âˆ’</button>
                                    <div class="counter-circle" onclick="adjustCount('strip', 1)" id="stripCount">0
                                    </div>
                                    <span class="counter-label">æ’</span>
                                </div>
                                <div class="counter-item">
                                    <button class="counter-minus" onclick="adjustCount('loose', -1)">âˆ’</button>
                                    <div class="counter-circle" onclick="adjustCount('loose', 1)" id="looseCount">0
                                    </div>
                                    <span class="counter-label">é¡†</span>
                                </div>
                            </div>
                            <button class="submit-btn-sm" onclick="submitDispensing()">âœ“</button>
                        </div>
                        <div class="inline-hint" id="inlineHint" aria-live="polite"></div>
                    </div>
                    <div class="desktop-drug-pool" id="desktopDrugPool" aria-label="æ¡Œé¢å€å¸¸å‚™è—¥">
                        <span class="desktop-drug-pool-label">æ¡Œé¢å€ï¼š</span>
                        <div class="desktop-drug-pool-items" id="desktopDrugPoolItems"></div>
                    </div>
                </div>

                <div class="drop-zone right-hand-zone" id="rightHandZone">
                    <div class="drop-zone-label">âœ‹ å³æ‰‹å€</div>
                    <div class="drop-zone-content" id="rightHandContent"></div>
                </div>
            </div>

            <!-- ä¸‹æ’ï¼šJ - I - H - G - F - E æŠ½å±œæ«ƒ -->
            <!-- ä¸‹æ’ï¼šJ - I - H - G - F - E æŠ½å±œæ«ƒ -->
            <div class="bottom-cabinet-row">
                <div class="drawer-cabinet" id="cabinetJ"></div>
                <div class="drawer-cabinet" id="cabinetI"></div>
                <div class="drawer-cabinet" id="cabinetH"></div>
                <div class="drawer-cabinet" id="cabinetG"></div>
                <div class="drawer-cabinet" id="cabinetF"></div>
                <div class="drawer-cabinet" id="cabinetE"></div>
            </div>
        </div>
    </div>

    <div class="feedback" id="feedback"></div>

    <!-- æ”¾å¤§è¦–çª—æ¨¡æ…‹ -->
    <div class="zoom-modal" id="zoomModal">
        <div class="zoom-content">
            <div class="zoom-header">
                <div class="zoom-title" id="zoomTitle"></div>
                <button class="zoom-close" onclick="closeZoomModal()">âœ•</button>
            </div>
            <div class="zoom-grid" id="zoomGrid"></div>
        </div>
    </div>

    <script src="drug_map.js"></script>
    <script src="drug_data.js"></script>

    <script>
        // drugDatabase èˆ‡ cabinetConfig å·²ç§»è‡³ drug_data.js

        // æª¢æŸ¥å¾Œå°ç™¼å¸ƒçš„è³‡æ–™ï¼ˆlocalStorageï¼‰ï¼Œè‹¥æœ‰å‰‡è¦†è“‹é è¨­è³‡æ–™
        (function() {
            try {
                const published = localStorage.getItem('drugDatabasePublished');
                if (published) {
                    const parsed = JSON.parse(published);
                    if (parsed.data && Array.isArray(parsed.data) && parsed.data.length > 0) {
                        // ç”¨å¾Œå°ç™¼å¸ƒçš„è³‡æ–™è¦†è“‹ drug_data.js çš„é è¨­å€¼
                        drugDatabase.length = 0;
                        parsed.data.forEach(d => drugDatabase.push(d));
                        console.log('[å¾Œå°ç™¼å¸ƒ] å·²è¼‰å…¥ ' + parsed.data.length + ' ç­†è—¥å“è³‡æ–™ (' + parsed.timestamp + ')');
                    }
                    // å¥—ç”¨å¾Œå°è¨­å®šçš„è—¥å“åœ–ç‰‡è¦†è“‹
                    if (parsed.imageOverrides && typeof parsed.imageOverrides === 'object') {
                        Object.assign(drugImageMap, parsed.imageOverrides);
                        console.log('[å¾Œå°ç™¼å¸ƒ] å·²å¥—ç”¨ ' + Object.keys(parsed.imageOverrides).length + ' ç­†åœ–ç‰‡è¦†è“‹');
                    }
                }
            } catch(e) { /* å¿½ç•¥è§£æéŒ¯èª¤ï¼Œä½¿ç”¨é è¨­è³‡æ–™ */ }
        })();

        // ==================== éŠæˆ²ç‹€æ…‹ ====================
        let gameState = {
            mode: 'location',
            score: 0,
            combo: 0,
            maxCombo: 0,
            timeLeft: 60,
            questionCount: 0,
            totalQuestions: 10,
            currentDrug: null,
            currentQuantity: 0,
            positionConfirmed: false,
            correctCount: 0,
            wrongCount: 0,
            wrongDrugs: [],
            timerInterval: null,
            isPlaying: false,
            hintMode: false, // æç¤ºæ¨¡å¼é–‹é—œ
            timerStarted: false, // è¨ˆæ™‚å™¨æ˜¯å¦å·²å•Ÿå‹•
            isPaused: false, // éŠæˆ²æ˜¯å¦æš«åœ
        };
        let inlineHintTimeout = null;

        // ==================== åˆå§‹åŒ– ====================
        function init() {
            generateCabinets();
        }

        // ==================== æ”¾å¤§è¦–çª—åŠŸèƒ½ ====================
        function openCabinetZoom(cabinet, type) {
            const modal = document.getElementById('zoomModal');
            const title = document.getElementById('zoomTitle');
            const grid = document.getElementById('zoomGrid');

            title.textContent = `${cabinet} æ«ƒè©³ç´°æª¢è¦–`;

            if (type === 'shelf') {
                // ä¸Šæ’æ¶å­æ”¾å¤§
                const rows = cabinet === 'A' ? 6 : 5;
                grid.className = 'zoom-grid shelf-layout';
                grid.innerHTML = '';

                for (let r = 1; r <= rows; r++) {
                    for (let c = 1; c <= 6; c++) {
                        const drug = drugDatabase.find(d =>
                            d.cabinet === cabinet && d.row === r && d.col === c && !d.section
                        );
                        grid.appendChild(createZoomDrugCard(drug, cabinet, r, c));
                    }
                }
            } else {
                // ä¸‹æ’æ«ƒå­æ”¾å¤§ï¼ˆ2x2ç¶²æ ¼å¸ƒå±€ï¼‰
                grid.className = '';
                grid.style.display = 'grid';
                grid.style.gridTemplateColumns = '1fr 1fr';
                grid.style.gap = '15px';
                grid.innerHTML = '';

                // è¼”åŠ©å‡½æ•¸ï¼šå–å¾—æŒ‡å®šå€åŸŸçš„æ‰€æœ‰è—¥å“ä¸¦ä»¥ç¶²æ ¼é¡¯ç¤º
                function getDrawerGridHTML(cab, section, title) {
                    const drugs = drugDatabase.filter(d => d.cabinet === cab && d.section === section);
                    if (drugs.length === 0) {
                        return `<div><h3 class="zoom-section-title">${title}</h3><div class="zoom-grid drawer-layout"><div class="zoom-drug-card empty"><div class="zoom-drug-name">ç©º</div></div></div></div>`;
                    }

                    // æ‰¾å‡ºæœ€å¤§è¡Œåˆ—æ•¸
                    const maxRow = Math.max(...drugs.map(d => d.row || 1));
                    const maxCol = Math.max(...drugs.map(d => d.col || 1));

                    let html = `<div><h3 class="zoom-section-title">${title}</h3><div class="zoom-grid" style="grid-template-columns: repeat(${Math.min(maxCol, 4)}, 1fr);">`;

                    for (let r = 1; r <= maxRow; r++) {
                        for (let c = 1; c <= Math.min(maxCol, 4); c++) {
                            const drug = drugs.find(d => (d.row || 1) === r && d.col === c);
                            html += createZoomDrugCard(drug, cab, r, c, section).outerHTML;
                        }
                    }
                    html += '</div></div>';
                    return html;
                }

                // æŠ½å±œ 1ï¼ˆå·¦ä¸Šï¼‰
                let drawer1HTML = getDrawerGridHTML(cabinet, 'drawer1', 'æŠ½å±œ 1');

                // æŠ½å±œ 2ï¼ˆå³ä¸Šï¼‰
                let drawer2HTML = getDrawerGridHTML(cabinet, 'drawer2', 'æŠ½å±œ 2');

                // å·¦é–€ï¼ˆå·¦ä¸‹ï¼‰- åªæœ‰ F æ«ƒæœ‰ Pacrea
                let doorLHTML = getDrawerGridHTML(cabinet, 'doorL', 'å·¦é–€');

                // å³é–€ï¼ˆå³ä¸‹ï¼‰
                let doorRHTML = getDrawerGridHTML(cabinet, 'doorR', 'å³é–€');

                grid.innerHTML = drawer1HTML + drawer2HTML + doorLHTML + doorRHTML;
            }

            modal.classList.add('active');
        }

        function openDrawerZoom(cabinet, section) {
            const modal = document.getElementById('zoomModal');
            const title = document.getElementById('zoomTitle');
            const grid = document.getElementById('zoomGrid');

            const sectionNames = {
                'drawer1': 'æŠ½å±œ 1',
                'drawer2': 'æŠ½å±œ 2',
                'doorL': 'å·¦é–€',
                'doorR': 'å³é–€'
            };

            title.textContent = `${cabinet} æ«ƒ - ${sectionNames[section]}è©³ç´°æª¢è¦–`;

            // å‹•æ…‹å–å¾—è©²å€åŸŸçš„æ‰€æœ‰è—¥å“
            const drugs = drugDatabase.filter(d => d.cabinet === cabinet && d.section === section);

            if (drugs.length === 0) {
                grid.className = 'zoom-grid drawer-layout';
                grid.innerHTML = '<div class="zoom-drug-card empty"><div class="zoom-drug-name">ç©º</div></div>';
                modal.classList.add('active');
                return;
            }

            // æ‰¾å‡ºæœ€å¤§è¡Œåˆ—æ•¸
            const maxRow = Math.max(...drugs.map(d => d.row || 1));
            const maxCol = Math.max(...drugs.map(d => d.col || 1));

            grid.className = 'zoom-grid';
            grid.style.gridTemplateColumns = `repeat(${Math.min(maxCol, 4)}, 1fr)`;
            grid.innerHTML = '';

            for (let r = 1; r <= maxRow; r++) {
                for (let c = 1; c <= Math.min(maxCol, 4); c++) {
                    const drug = drugs.find(d => (d.row || 1) === r && d.col === c);
                    grid.appendChild(createZoomDrugCard(drug, cabinet, r, c, section));
                }
            }

            modal.classList.add('active');
        }

        function createZoomDrugCard(drug, cabinet, row, col, section) {
            const card = document.createElement('div');

            if (!drug) {
                card.className = 'zoom-drug-card empty';
                card.innerHTML = '<div class="zoom-drug-name">ç©ºæ ¼</div>';
                return card;
            }

            card.className = `zoom-drug-card ${drug.isBox ? 'box' : ''}`;

            let locationText = '';
            if (row) {
                locationText = `ä½ç½®ï¼šç¬¬ ${row} è¡Œ ç¬¬ ${col} åˆ—`;
            } else if (section) {
                locationText = `ä½ç½®ï¼šç¬¬ ${col} æ ¼`;
            }

            card.innerHTML = `
                <div class="zoom-drug-name">${drug.name}</div>
                <div class="zoom-drug-info">
                    ${drug.isBox ? 'ç›’è£' : 'æ•£è£'}<br>
                    ä¸€æ’ï¼š${drug.stripSize} é¡†<br>
                    ä¸€ç›’ï¼š${drug.boxSize} é¡†
                </div>
                <div class="zoom-drug-location">${locationText}</div>
            `;

            // é»æ“Šå¡ç‰‡æ™‚ï¼šéŠæˆ²ä¸­è§¸ç™¼é¸å–é‚è¼¯ï¼ŒééŠæˆ²æ™‚åƒ…é¡¯ç¤ºåœ–ç‰‡
            card.onclick = (e) => {
                e.stopPropagation();
                closeZoomModal();

                if (gameState.isPlaying && gameState.currentDrug) {
                    // è¨­å®š data attributes ä¾› selectSlot() ä½¿ç”¨
                    card.dataset.cabinet = cabinet;
                    card.dataset.section = section || '';
                    card.dataset.row = row || '';
                    card.dataset.col = col;
                    selectSlot(card);
                } else {
                    showDrugImage(drug.name);
                }
            };

            return card;
        }

        function closeZoomModal() {
            const modal = document.getElementById('zoomModal');
            modal.classList.remove('active');
        }

        // é»æ“Šæ¨¡æ…‹èƒŒæ™¯é—œé–‰
        document.addEventListener('DOMContentLoaded', () => {
            const modal = document.getElementById('zoomModal');
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeZoomModal();
                }
            });
        });

        // ==================== æç¤ºæ¨¡å¼åŠŸèƒ½ ====================
        function toggleHintMode() {
            gameState.hintMode = !gameState.hintMode;
            const toggle = document.getElementById('hintToggle');
            const icon = document.getElementById('hintToggleIcon');
            const text = document.getElementById('hintToggleText');

            if (gameState.hintMode) {
                toggle.classList.add('active');
                icon.textContent = 'âœ¨';
                text.textContent = 'æç¤ºæ¨¡å¼ï¼šé–‹å•Ÿ';
            } else {
                toggle.classList.remove('active');
                icon.textContent = 'ğŸ’¡';
                text.textContent = 'æç¤ºæ¨¡å¼ï¼šé—œé–‰';
            }

            // å¦‚æœéŠæˆ²æ­£åœ¨é€²è¡Œï¼Œæ›´æ–°æç¤ºé¡¯ç¤º
            if (gameState.isPlaying && gameState.currentDrug) {
                updateHintDisplay();
            }
        }

        function updateHintDisplay() {
            const hintElement = document.getElementById('drugHintLocation');
            if (!hintElement) return;

            if (gameState.hintMode && gameState.currentDrug) {
                const drug = gameState.currentDrug;
                let hintText = `ğŸ“ ä½æ–¼ ${drug.cabinet} æ«ƒ`;

                // Logic to highlight the broad area (Continuous Hint)
                // First remove old highlights
                document.querySelectorAll('.cabinet-hint-active').forEach(el => el.classList.remove('cabinet-hint-active'));

                let targetElementId = null;
                let targetSubSelector = null;

                if (['C', 'B', 'A'].includes(drug.cabinet)) {
                    targetElementId = `cabinet${drug.cabinet}`;
                    // For shelf cabinets, highlight the whole cabinet
                    const el = document.getElementById(targetElementId);
                    if (el) el.classList.add('cabinet-hint-active');
                } else {
                    // For drawer cabinets
                    targetElementId = `cabinet${drug.cabinet}`;
                    const cabEl = document.getElementById(targetElementId);

                    if (drug.section && cabEl) {
                        // Find the specific section (drawer/door) inside
                        if (drug.section === 'drawer1') {
                            const el = cabEl.querySelector('.drawer-section:nth-of-type(1)');
                            if (el) el.classList.add('cabinet-hint-active');
                        } else if (drug.section === 'drawer2') {
                            const el = cabEl.querySelector('.drawer-section:nth-of-type(2)');
                            if (el) el.classList.add('cabinet-hint-active');
                        } else if (drug.section === 'doorL') {
                            const el = cabEl.querySelector('.door:nth-of-type(1)');
                            if (el) el.classList.add('cabinet-hint-active');
                        } else if (drug.section === 'doorR') {
                            const el = cabEl.querySelector('.door:nth-of-type(2)');
                            if (el) el.classList.add('cabinet-hint-active');
                        }
                    }
                }

                if (drug.section) {
                    const sectionNames = {
                        'drawer1': 'æŠ½å±œ 1',
                        'drawer2': 'æŠ½å±œ 2',
                        'doorL': 'å·¦é–€',
                        'doorR': 'å³é–€'
                    };
                    hintText += ` - ${sectionNames[drug.section]}`;
                } else if (drug.row) {
                    hintText += ` - ç¬¬ ${drug.row} è¡Œ`;
                }

                hintElement.textContent = hintText;
                hintElement.style.display = 'inline';
            } else {
                hintElement.textContent = '';
                hintElement.style.display = 'none';

                // Remove highlights
                document.querySelectorAll('.cabinet-hint-active').forEach(el => el.classList.remove('cabinet-hint-active'));
            }
        }

        function showLocationHint() {
            if (!gameState.currentDrug || !gameState.isPlaying) return;

            const drug = gameState.currentDrug;

            // æ‰¾åˆ°æ­£ç¢ºçš„è—¥å“æ ¼å­
            let targetSlot = null;

            if (drug.cabinet === 'Desktop') {
                // æ¡Œé¢å€è—¥å“
                const desktopItems = document.querySelectorAll('#desktopDrugPoolItems .desktop-drug-item');
                desktopItems.forEach(item => {
                    if (item.textContent.trim() === drug.name) {
                        targetSlot = item;
                    }
                });
            } else {
                // æ«ƒä½è—¥å“
                const allSlots = document.querySelectorAll('.drug-slot');
                allSlots.forEach(slot => {
                    const slotCabinet = slot.dataset.cabinet;
                    const slotRow = parseInt(slot.dataset.row);
                    const slotCol = parseInt(slot.dataset.col);
                    const slotSection = slot.dataset.section;

                    let isMatch = slotCabinet === drug.cabinet;

                    if (drug.section) {
                        isMatch = isMatch && slotSection === drug.section && slotCol === drug.col;
                    } else {
                        isMatch = isMatch && slotRow === drug.row && slotCol === drug.col && !slotSection;
                    }

                    if (isMatch) {
                        targetSlot = slot;
                    }
                });
            }

            if (targetSlot) {
                // ç§»é™¤ä¹‹å‰çš„é–ƒçˆæ•ˆæœ
                document.querySelectorAll('.slot-blinking').forEach(el => {
                    el.classList.remove('slot-blinking');
                });

                // æ·»åŠ é–ƒçˆæ•ˆæœ
                targetSlot.classList.add('slot-blinking');

                // æ²å‹•åˆ°è©²å…ƒç´ 
                targetSlot.scrollIntoView({ behavior: 'smooth', block: 'center' });

                // 3ç§’å¾Œç§»é™¤é–ƒçˆæ•ˆæœ
                setTimeout(() => {
                    targetSlot.classList.remove('slot-blinking');
                }, 3000);
            }
        }

        function generateCabinets() {
            // ä¸Šæ’æ¶å­ï¼šC, B (5å±¤), A (6å±¤)
            ['C', 'B', 'A'].forEach(cab => {
                const el = document.getElementById(`cabinet${cab}`);
                const rows = cab === 'A' ? 6 : 5; // Aæ«ƒæœ‰6å±¤ï¼ŒCå’ŒBæ«ƒæœ‰5å±¤
                el.innerHTML = `
                    <div class="cab-label">${cab} æ«ƒ (é»æ“Šæ”¾å¤§)</div>
                    <div class="shelf-grid">${generateShelfSlots(cab, rows, 6)}</div>
                `;
                // Make entire cabinet clickable
                el.onclick = function (e) {
                    // Verify we aren't clicking a slot directly (slots have their own logic)
                    if (!e.target.classList.contains('drug-slot')) {
                        openCabinetZoom(cab, 'shelf');
                    }
                };
            });

            // ä¸‹æ’æ«ƒå­ï¼šJ, I, H, G, F, E (æŠ½å±œ+é–€)
            ['J', 'I', 'H', 'G', 'F', 'E'].forEach(cab => {
                const el = document.getElementById(`cabinet${cab}`);
                el.innerHTML = `
                    <div class="cab-label">${cab} æ«ƒ</div>
                    <div class="drawer-section" onclick="openDrawerZoom('${cab}', 'drawer1'); event.stopPropagation();">
                        <div class="drawer-label">æŠ½å±œ 1</div>
                        <div class="drawer-grid pointer-events-none">${generateDrawerSlots(cab, 'drawer1')}</div>
                    </div>
                    <div class="drawer-section" onclick="openDrawerZoom('${cab}', 'drawer2'); event.stopPropagation();">
                        <div class="drawer-label">æŠ½å±œ 2</div>
                        <div class="drawer-grid pointer-events-none">${generateDrawerSlots(cab, 'drawer2')}</div>
                    </div>
                    <div class="door-section">
                        <div class="door" onclick="openDrawerZoom('${cab}', 'doorL'); event.stopPropagation();">
                            <div class="door-label">å·¦é–€</div>
                            <div class="door-grid pointer-events-none">${generateDoorSlots(cab, 'doorL')}</div>
                        </div>
                        <div class="door" onclick="openDrawerZoom('${cab}', 'doorR'); event.stopPropagation();">
                            <div class="door-label">å³é–€</div>
                            <div class="door-grid pointer-events-none">${generateDoorSlots(cab, 'doorR')}</div>
                        </div>
                    </div>
                `;
            });

            // Re-enable pointer events for slots inside
            document.querySelectorAll('.drawer-grid .drug-slot, .door-grid .drug-slot').forEach(slot => {
                slot.parentElement.style.pointerEvents = 'none'; // Grid container ignores clicks
                slot.style.pointerEvents = 'auto'; // But slots inside accept them
            });

            // æ¡Œé¢å€ - åˆå§‹åŒ–æ‹–æ‹‰åŠŸèƒ½
            generateDesktopDrugs();
            initDragAndDrop();
        }

        function generateShelfSlots(cabinet, rows, cols) {
            let html = '';
            for (let r = 1; r <= rows; r++) {
                for (let c = 1; c <= cols; c++) {
                    const drug = drugDatabase.find(d =>
                        d.cabinet === cabinet && d.row === r && d.col === c && !d.section
                    );
                    const name = drug ? drug.name : '';
                    const displayName = name.length > 10 ? name.substring(0, 10) + '..' : name;
                    const boxClass = drug?.isBox ? 'box' : '';
                    const draggable = name ? 'true' : 'false';
                    html += `<div class="drug-slot ${boxClass}"
                        draggable="${draggable}"
                        data-cabinet="${cabinet}"
                        data-row="${r}"
                        data-col="${c}"
                        data-drug-name="${name}"
                        onclick="selectSlot(this); event.stopPropagation();"
                        title="${name}">${displayName}</div>`;
                }
            }
            return html;
        }

        function generateDrawerSlots(cabinet, section) {
            let html = '';
            for (let c = 1; c <= 3; c++) {
                // åªé¡¯ç¤ºç¬¬ä¸€æ’çš„è—¥å“ä½œç‚ºé è¦½
                const drug = drugDatabase.find(d =>
                    d.cabinet === cabinet && d.section === section && d.col === c && (d.row === 1 || !d.row)
                );
                const name = drug ? drug.name : '';
                const displayName = name.length > 8 ? name.substring(0, 8) + '..' : name;
                const boxClass = drug?.isBox ? 'box' : '';
                const draggable = name ? 'true' : 'false';
                html += `<div class="drug-slot ${boxClass}"
                    draggable="${draggable}"
                    data-cabinet="${cabinet}"
                    data-section="${section}"
                    data-col="${c}"
                    data-drug-name="${name}"
                    onclick="selectSlot(this); event.stopPropagation();"
                    title="${name}">${displayName}</div>`;
            }
            return html;
        }

        function generateDoorSlots(cabinet, section) {
            let html = '';
            for (let c = 1; c <= 2; c++) {
                const drug = drugDatabase.find(d =>
                    d.cabinet === cabinet && d.section === section && d.col === c
                );
                const name = drug ? drug.name : '';
                const displayName = name.length > 7 ? name.substring(0, 7) + '..' : name;
                const boxClass = drug?.isBox ? 'box' : '';
                const draggable = name ? 'true' : 'false';
                html += `<div class="drug-slot ${boxClass}"
                    draggable="${draggable}"
                    data-cabinet="${cabinet}"
                    data-section="${section}"
                    data-col="${c}"
                    data-drug-name="${name}"
                    onclick="selectSlot(this); event.stopPropagation();"
                    title="${name}">${displayName}</div>`;
            }
            return html;
        }

        function generateDesktopDrugs() {
            const pool = document.getElementById('desktopDrugPool');
            const container = document.getElementById('desktopDrugPoolItems');
            if (!container) return;

            container.innerHTML = '';
            const desktopDrugs = drugDatabase.filter(d => d.cabinet === 'Desktop');

            desktopDrugs.forEach(drug => {
                const item = document.createElement('div');
                item.className = 'draggable-drug';
                item.draggable = false;
                item.dataset.drugName = drug.name;
                item.textContent = drug.name;
                item.title = drug.name;
                item.onclick = function () { selectDesktopDrug(this); };
                container.appendChild(item);
            });

            if (pool) {
                pool.style.display = desktopDrugs.length ? 'flex' : 'none';
            }
        }

        function initDragAndDrop() {
            const zones = ['leftHandZone', 'rightHandZone'];

            zones.forEach(zoneId => {
                const zone = document.getElementById(zoneId);
                if (!zone) return;
                const content = zone.querySelector('.drop-zone-content');

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', (e) => {
                    if (!zone.contains(e.relatedTarget)) {
                        zone.classList.remove('drag-over');
                    }
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const drugName = e.dataTransfer.getData('text/plain');
                    const sourceType = e.dataTransfer.getData('source-type');

                    // æª¢æŸ¥æ˜¯å¦å·²ç¶“åœ¨å·¦å³æ‰‹å€å­˜åœ¨æ­¤è—¥å“
                    let existingDrug = document.querySelector(`.draggable-drug[data-drug-name="${drugName}"]`);

                    if (existingDrug) {
                        // ç§»å‹•å·²å­˜åœ¨çš„è—¥å“
                        existingDrug.classList.remove('in-left', 'in-right');
                        if (zoneId === 'leftHandZone') {
                            existingDrug.classList.add('in-left');
                        } else if (zoneId === 'rightHandZone') {
                            existingDrug.classList.add('in-right');
                        }
                        content.appendChild(existingDrug);
                    } else if (sourceType === 'cabinet' && drugName) {
                        // å¾è—¥æ«ƒæ‹–å…¥ï¼šå»ºç«‹æ–°çš„è—¥å“æ¨™ç±¤
                        const newDrug = document.createElement('div');
                        newDrug.className = 'draggable-drug';
                        newDrug.draggable = true;
                        newDrug.dataset.drugName = drugName;
                        newDrug.textContent = drugName;
                        newDrug.onclick = function () { selectDesktopDrug(this); };

                        if (zoneId === 'leftHandZone') {
                            newDrug.classList.add('in-left');
                        } else if (zoneId === 'rightHandZone') {
                            newDrug.classList.add('in-right');
                        }

                        content.appendChild(newDrug);
                    }
                });
            });

            // ç‚ºæ¡Œé¢å¯æ‹–æ›³è—¥å“ç¶å®šäº‹ä»¶
            document.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('draggable-drug')) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', e.target.dataset.drugName);
                    e.dataTransfer.setData('source-type', 'desktop');
                    e.dataTransfer.effectAllowed = 'move';
                }
                // è—¥æ«ƒæ ¼å­æ‹–æ›³
                else if (e.target.classList.contains('drug-slot') && e.target.dataset.drugName) {
                    e.target.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', e.target.dataset.drugName);
                    e.dataTransfer.setData('source-type', 'cabinet');
                    e.dataTransfer.effectAllowed = 'copy';
                }
            });

            document.addEventListener('dragend', (e) => {
                if (e.target.classList.contains('draggable-drug') || e.target.classList.contains('drug-slot')) {
                    e.target.classList.remove('dragging');
                }
            });
        }

        function selectDesktopDrug(element) {
            if (!gameState.isPlaying || !gameState.currentDrug) return;

            const drugName = element.dataset.drugName;
            const drug = gameState.currentDrug;

            // æª¢æŸ¥æ˜¯å¦ç‚ºæ­£ç¢ºçš„è—¥å“
            if (drug.cabinet === 'Desktop' && drug.name === drugName) {
                element.style.outline = '3px solid #4caf50';
                if (gameState.mode === 'location') {
                    handleCorrect();
                } else {
                    markPositionConfirmed();
                }
            } else if (drug.cabinet === 'Desktop') {
                element.style.outline = '3px solid #f44336';
                handleWrong();
                // é«˜äº®æ­£ç¢ºçš„è—¥å“
                const correctDrug = document.querySelector(`.draggable-drug[data-drug-name="${drug.name}"]`);
                if (correctDrug) {
                    correctDrug.style.outline = '3px solid #ffc107';
                    correctDrug.style.animation = 'glow 1s infinite';
                }
            }
        }

        // ==================== éŠæˆ²æ§åˆ¶ ====================
        function startGame() {
            document.getElementById('startScreen').classList.add('hidden');
            resetGame();
            gameState.isPlaying = true;
            showGameControls(true);
            // è¨ˆæ™‚å™¨æ”¹ç‚ºç¬¬ä¸€æ¬¡ä½œç­”æ‰é–‹å§‹ï¼Œä¸åœ¨é€™è£¡å•Ÿå‹•
            nextQuestion();
        }

        function resetGame() {
            gameState.score = 0;
            gameState.combo = 0;
            gameState.maxCombo = 0;
            gameState.timeLeft = gameState.mode === 'rush' ? 180 : 120;
            gameState.questionCount = 0;
            gameState.correctCount = 0;
            gameState.wrongCount = 0;
            gameState.wrongDrugs = [];
            gameState.positionConfirmed = false;
            gameState.timerStarted = false;
            gameState.isPaused = false;
            clearInlineHint();
            resetCounters();
            updateDisplay();

            // é‡ç½®æš«åœæŒ‰éˆ•ç‹€æ…‹
            const pauseBtn = document.getElementById('pauseBtn');
            if (pauseBtn) {
                pauseBtn.textContent = 'â¸ï¸ æš«åœ';
                pauseBtn.classList.remove('paused');
            }
        }

        function restartGame() {
            document.getElementById('resultScreen').classList.remove('active');
            resetGame();
            gameState.isPlaying = true;
            showGameControls(true);
            // è¨ˆæ™‚å™¨æ”¹ç‚ºç¬¬ä¸€æ¬¡ä½œç­”æ‰é–‹å§‹ï¼Œä¸åœ¨é€™è£¡å•Ÿå‹•
            nextQuestion();
        }

        function startTimer() {
            if (gameState.timerInterval) clearInterval(gameState.timerInterval);
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;
                if (gameState.timeLeft <= 0) endGame();
            }, 1000);
        }

        function togglePause() {
            if (!gameState.isPlaying || !gameState.timerStarted) return;

            const pauseBtn = document.getElementById('pauseBtn');
            if (gameState.isPaused) {
                // ç¹¼çºŒéŠæˆ²
                gameState.isPaused = false;
                startTimer();
                pauseBtn.textContent = 'â¸ï¸ æš«åœ';
                pauseBtn.classList.remove('paused');
            } else {
                // æš«åœéŠæˆ²
                gameState.isPaused = true;
                clearInterval(gameState.timerInterval);
                pauseBtn.textContent = 'â–¶ï¸ ç¹¼çºŒ';
                pauseBtn.classList.add('paused');
            }
        }

        function showGameControls(show) {
            document.getElementById('pauseBtn').style.display = show ? 'inline-block' : 'none';
            document.getElementById('restartBtn').style.display = show ? 'inline-block' : 'none';
        }

        function endGame() {
            gameState.isPlaying = false;
            gameState.isPaused = false;
            clearInterval(gameState.timerInterval);
            showGameControls(false);

            // é‡ç½®æš«åœæŒ‰éˆ•ç‹€æ…‹
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = 'â¸ï¸ æš«åœ';
            pauseBtn.classList.remove('paused');

            // ç¦ç”¨æç¤ºæŒ‰éˆ•
            document.getElementById('showHintBtn').disabled = true;

            const accuracy = gameState.correctCount + gameState.wrongCount > 0
                ? Math.round((gameState.correctCount / (gameState.correctCount + gameState.wrongCount)) * 100)
                : 0;

            document.getElementById('finalScore').textContent = gameState.score;
            document.getElementById('finalAccuracy').textContent = accuracy;
            document.getElementById('finalCombo').textContent = gameState.maxCombo;

            if (gameState.wrongDrugs.length > 0) {
                const uniqueWrong = [...new Set(gameState.wrongDrugs)];
                const wrongList = uniqueWrong.slice(0, 8).map(name => {
                    const d = drugDatabase.find(x => x.name === name);
                    let loc = `${d.cabinet}æ«ƒ`;
                    if (d.section) loc += `-${d.section.replace('drawer', 'æŠ½å±œ').replace('door', 'é–€')}`;
                    else if (d.row) loc += `-${d.row}è¡Œ`;
                    return `<li>${name} <span style="color:#666; font-size:0.9em">(${loc})</span></li>`;
                }).join('');

                document.getElementById('errorDrugs').innerHTML =
                    `<div style="text-align:left; margin-top:15px;">
                        <p style="font-weight:bold; color:#d35400;">âš ï¸ éœ€åŠ å¼·çš„è—¥å“ï¼š</p>
                        <ul style="font-size:0.95rem; line-height:1.6; padding-left:20px;">${wrongList}</ul>
                     </div>`;
            } else {
                document.getElementById('errorDrugs').innerHTML = '<p style="color:#27ae60; margin-top:15px;">âœ¨ å®Œç¾ï¼æ²’æœ‰éŒ¯èª¤è—¥å“ï¼</p>';
            }

            document.getElementById('resultScreen').classList.add('active');
        }

        function setMode(mode) {
            gameState.mode = mode;
            document.querySelectorAll('.mode-btn-sm').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.mode-btn-sm.${mode}`).classList.add('active');

            // åˆ‡æ›é¡¯ç¤ºæ¨¡å¼
            const isLocation = (mode === 'location');
            document.getElementById('locationModeRow').style.display = isLocation ? 'flex' : 'none';
            document.getElementById('dispensingModeRow').style.display = isLocation ? 'none' : 'flex';
            clearInlineHint();

            if (gameState.isPlaying) {
                resetGame();
                // è¨ˆæ™‚å™¨æ”¹ç‚ºç¬¬ä¸€æ¬¡ä½œç­”æ‰é–‹å§‹ï¼Œä¸åœ¨é€™è£¡å•Ÿå‹•
                nextQuestion();
            }
        }

        // è¨ˆæ•¸å™¨èª¿æ•´å‡½æ•¸
        function adjustCount(type, delta) {
            const elementId = type + 'Count';
            const el = document.getElementById(elementId);
            let val = parseInt(el.textContent) || 0;
            val = Math.max(0, val + delta);
            el.textContent = val;
        }

        function resetCounters() {
            document.getElementById('boxCount').textContent = '0';
            document.getElementById('stripCount').textContent = '0';
            document.getElementById('looseCount').textContent = '0';
        }

        // ==================== é¡Œç›®é‚è¼¯ ====================
        function nextQuestion() {
            if (!gameState.isPlaying) return;

            // æ¸…é™¤æ‰€æœ‰ä½ç½®æç¤ºé«˜äº®
            document.querySelectorAll('.slot-blinking').forEach(el => {
                el.classList.remove('slot-blinking');
                el.style.animation = '';
            });
            document.querySelectorAll('.cabinet-hint-active').forEach(el => {
                el.classList.remove('cabinet-hint-active');
            });

            // æ¸…é™¤æ‰€æœ‰è—¥ç‰©æ ¼å­çš„é«˜äº®ç‹€æ…‹
            document.querySelectorAll('.drug-slot').forEach(slot => {
                slot.classList.remove('correct', 'wrong', 'highlight', 'slot-blinking');
                slot.style.animation = '';
                slot.style.outline = '';
            });

            // æ¸…é™¤æ¡Œé¢è—¥å“æ¨£å¼
            document.querySelectorAll('.draggable-drug').forEach(drug => {
                drug.style.outline = '';
                drug.style.animation = '';
            });

            // æ¸…é™¤å³æ‰‹å€è—¥å“åœ–ç‰‡
            closeDrugImageInPanel();

            const randomIndex = Math.floor(Math.random() * drugDatabase.length);
            gameState.currentDrug = drugDatabase[randomIndex];

            const prescriptionCard = document.querySelector('.prescription-compact');
            if (prescriptionCard) prescriptionCard.classList.remove('position-ok');
            gameState.positionConfirmed = false;
            clearInlineHint();

            if (gameState.mode !== 'location') {
                gameState.currentQuantity = generateQuantity(gameState.currentDrug);
            }

            const drug = gameState.currentDrug;

            if (gameState.mode === 'location') {
                // å®šä½æ¨¡å¼
                document.getElementById('drugNameLocation').textContent = drug.name;

                // æ ¹æ“šæç¤ºæ¨¡å¼æ±ºå®šæ˜¯å¦é¡¯ç¤ºä½ç½®æç¤º
                updateHintDisplay();

                // å•Ÿç”¨ã€Œé¡¯ç¤ºä½ç½®æç¤ºã€æŒ‰éˆ•
                document.getElementById('showHintBtn').disabled = false;
            } else {
                // é…è—¥/æ¸¬è©¦æ¨¡å¼
                document.getElementById('drugNameDispensing').textContent = drug.name;
                document.getElementById('drugQuantityBadge').textContent = `Ã—${gameState.currentQuantity}`;
                document.getElementById('specBadge').textContent = `${drug.stripSize}/æ’ ${drug.boxSize}/ç›’`;
            }

            // Update Image
            updateDrugImage(drug.name);

            // é‡ç½®è¨ˆæ•¸å™¨
            resetCounters();

            gameState.questionCount++;
            updateDisplay();
        }

        function showDrugImage(drugName) {
            // Check if drugImageMap is loaded
            if (typeof drugImageMap !== 'undefined' && drugImageMap[drugName]) {
                const rightHandContent = document.getElementById('rightHandContent');

                // æ¸…é™¤èˆŠå…§å®¹ä¸¦é¡¯ç¤ºè—¥å“åœ–ç‰‡
                rightHandContent.innerHTML = `
                    <div class="drug-image-container" id="drugImageInPanel">
                        <button class="drug-image-close" onclick="closeDrugImageInPanel()">âœ•</button>
                        <img src="${drugImageMap[drugName]}" alt="${drugName}" class="drug-image-preview">
                        <div class="drug-image-name">${drugName}</div>
                    </div>
                `;
            }
        }

        function closeDrugImageInPanel() {
            const rightHandContent = document.getElementById('rightHandContent');
            rightHandContent.innerHTML = '';
        }

        function toggleDrugImage() {
            const overlay = document.getElementById('drugImageOverlay');
            overlay.style.display = 'none';
        }

        function generateQuantity(drug) {
            const options = [
                drug.stripSize,
                drug.stripSize * 2,
                drug.boxSize,
                drug.boxSize + drug.stripSize,
                Math.floor(drug.stripSize * 1.5),
                drug.stripSize * 3 + Math.floor(drug.stripSize / 2),
            ];
            return options[Math.floor(Math.random() * options.length)];
        }

        // ==================== ä½¿ç”¨è€…äº’å‹• ====================
        function selectSlot(element) {
            if (!gameState.isPlaying || !gameState.currentDrug) return;

            // ç¬¬ä¸€æ¬¡ä½œç­”æ™‚å•Ÿå‹•è¨ˆæ™‚å™¨
            if (!gameState.timerStarted) {
                gameState.timerStarted = true;
                startTimer();
            }

            const cabinet = element.dataset.cabinet;
            const section = element.dataset.section || null;
            const row = element.dataset.row ? parseInt(element.dataset.row) : null;
            const col = parseInt(element.dataset.col);
            const drug = gameState.currentDrug;

            // æ‰¾åˆ°è¢«é»æ“Šçš„è—¥å“è³‡æ–™
            const clickedDrug = drugDatabase.find(d => {
                let match = d.cabinet === cabinet && d.col === col;
                if (section) {
                    match = match && d.section === section;
                } else if (row) {
                    match = match && d.row === row && !d.section;
                }
                return match;
            });

            // æ›´æ–°è¦æ ¼è³‡è¨Šé¡¯ç¤ºï¼ˆé…è—¥/æ¸¬è©¦æ¨¡å¼ï¼‰
            if (clickedDrug && gameState.mode !== 'location') {
                document.getElementById('specBadge').textContent = `${clickedDrug.stripSize}/æ’ ${clickedDrug.boxSize}/ç›’`;
            }

            let isCorrect = drug.cabinet === cabinet && drug.col === col;
            if (drug.section) {
                isCorrect = isCorrect && drug.section === section;
            } else if (drug.row) {
                isCorrect = isCorrect && drug.row === row;
            }

            if (isCorrect) {
                element.classList.add('correct');
                // Show Image Overlay on Click
                showDrugImage(drug.name);

                if (gameState.mode === 'location') {
                    handleCorrect();
                } else {
                    markPositionConfirmed();
                }
            } else {
                element.classList.add('wrong');
                handleWrong();
                highlightCorrectSlot();
            }
        }

        function markPositionConfirmed() {
            const prescriptionCard = document.querySelector('.prescription-compact');
            if (prescriptionCard) prescriptionCard.classList.add('position-ok');
            gameState.positionConfirmed = true;

            // ç¢ºä¿è¦æ ¼è³‡è¨Šæ­£ç¢ºé¡¯ç¤ºç‚ºé¡Œç›®è—¥å“çš„è¦æ ¼
            const drug = gameState.currentDrug;
            if (drug) {
                document.getElementById('specBadge').textContent = `${drug.stripSize}/æ’ ${drug.boxSize}/ç›’`;
            }

            // ä½ç½®ç¢ºèªå¾Œé‡ç½®è¨ˆæ•¸å™¨ï¼Œè®“ç”¨æˆ¶å¾é›¶é–‹å§‹è¨ˆç®—æ­£ç¢ºçš„è—¥å“
            resetCounters();
        }

        function highlightCorrectSlot() {
            const drug = gameState.currentDrug;

            // æ¡Œé¢è—¥å“ç‰¹æ®Šè™•ç†
            if (drug.cabinet === 'Desktop') {
                const correctDrug = document.querySelector(`.draggable-drug[data-drug-name="${drug.name}"]`);
                if (correctDrug) {
                    correctDrug.style.outline = '3px solid #ffc107';
                    correctDrug.style.animation = 'glow 1s infinite';
                }
                return;
            }

            let selector;
            if (drug.section) {
                selector = `[data-cabinet="${drug.cabinet}"][data-section="${drug.section}"][data-col="${drug.col}"]`;
            } else if (drug.row) {
                selector = `[data-cabinet="${drug.cabinet}"][data-row="${drug.row}"][data-col="${drug.col}"]`;
            } else {
                selector = `[data-cabinet="${drug.cabinet}"][data-col="${drug.col}"]`;
            }
            const correctSlot = document.querySelector(selector);
            if (correctSlot) correctSlot.classList.add('highlight');
        }

        function submitDispensing() {
            if (!gameState.isPlaying || !gameState.currentDrug) return;

            if (!gameState.positionConfirmed) {
                handleWrong();
                highlightCorrectSlot();
                showInlineHint('âœ— è«‹å…ˆé»é¸æ­£ç¢ºä½ç½®', 'wrong');
                return;
            }

            const boxCount = parseInt(document.getElementById('boxCount').textContent) || 0;
            const stripCount = parseInt(document.getElementById('stripCount').textContent) || 0;
            const looseCount = parseInt(document.getElementById('looseCount').textContent) || 0;

            const drug = gameState.currentDrug;
            const totalDispensed = (boxCount * drug.boxSize) + (stripCount * drug.stripSize) + looseCount;

            if (totalDispensed === gameState.currentQuantity) {
                handleCorrect();
            } else {
                handleWrong();
                showInlineHint(`âœ— é¡†æ•¸éŒ¯èª¤ï¼æ‡‰é… ${gameState.currentQuantity} é¡†`, 'wrong');
            }
        }

        function handleCorrect() {
            gameState.combo++;
            if (gameState.combo > gameState.maxCombo) gameState.maxCombo = gameState.combo;

            const comboBonus = Math.min(gameState.combo * 10, 50);
            const points = 100 + comboBonus;
            gameState.score += points;
            gameState.correctCount++;

            if (gameState.mode === 'location') {
                showFeedback(`âœ“ æ­£ç¢ºï¼+${points}`, 'correct');
            } else {
                showInlineHint(`âœ“ æ­£ç¢ºï¼+${points}`, 'correct');
            }
            updateDisplay();

            // ç«‹å³æ­¸é›¶è¨ˆæ•¸å™¨ï¼Œä¸ç­‰ nextQuestion çš„ 700ms å»¶é²
            resetCounters();

            setTimeout(() => {
                if (gameState.mode === 'rush' || gameState.questionCount < gameState.totalQuestions) {
                    nextQuestion();
                } else {
                    endGame();
                }
            }, 700);
        }

        function handleWrong() {
            gameState.combo = 0;
            gameState.wrongCount++;
            gameState.score = Math.max(0, gameState.score - 20);

            if (!gameState.wrongDrugs.includes(gameState.currentDrug.name)) {
                gameState.wrongDrugs.push(gameState.currentDrug.name);
            }

            updateDisplay();

            if (gameState.mode === 'location') {
                showFeedback('âœ— éŒ¯èª¤ï¼', 'wrong');
                setTimeout(() => {
                    if (gameState.questionCount < gameState.totalQuestions) {
                        nextQuestion();
                    } else {
                        endGame();
                    }
                }, 1200);
            }
        }

        function updateDisplay() {
            document.getElementById('score').textContent = gameState.score;
            document.getElementById('combo').textContent = gameState.combo;
            document.getElementById('questionCount').textContent =
                gameState.mode === 'rush'
                    ? `${gameState.correctCount}`
                    : `${gameState.questionCount}/${gameState.totalQuestions}`;
        }

        function showFeedback(message, type) {
            const feedback = document.getElementById('feedback');
            feedback.textContent = message;
            feedback.className = `feedback ${type}`;
            feedback.style.display = 'block';
            setTimeout(() => { feedback.style.display = 'none'; }, 1200);
        }

        function clearInlineHint() {
            const hint = document.getElementById('inlineHint');
            if (!hint) return;
            hint.textContent = '';
            hint.className = 'inline-hint';
            hint.style.display = 'none';
            if (inlineHintTimeout) clearTimeout(inlineHintTimeout);
            inlineHintTimeout = null;
        }

        function showInlineHint(message, type) {
            const hint = document.getElementById('inlineHint');
            if (!hint) return;
            hint.textContent = message;
            hint.className = `inline-hint show ${type}`;
            hint.style.display = 'block';
            if (inlineHintTimeout) clearTimeout(inlineHintTimeout);
            inlineHintTimeout = setTimeout(() => {
                hint.style.display = 'none';
                hint.className = 'inline-hint';
                hint.textContent = '';
            }, 900);
        }

        init();
    </script>
</body>

</html>