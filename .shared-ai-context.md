# NTUHPharmGame - 上下文共享

> 最後更新：2026-02-23 by Codex (GPT-5)

## 基本規範

- **此專案使用 Git 版本控制**
- 所有變更應有適當的 commit

## age 加密（Cloud VM Secrets）

- **私鑰**：`age-key.txt`（本機保留、git ignored）
- **加密檔**：`.env.age`（可安全提交）
- **解密腳本**：`.claude/setup.sh`
- **allowlist**：`secrets/env.keys`（用於從全域環境匯出本機 `.env`）

## Git 歷史

```
* 2537ab0 fix: hide image fallback when preview loads
* 420fa8e docs: sync shared context for Patch3 game update
* e4b6285 feat: merge Patch3 GHIJ layout and image fallbacks
* 4275e7d docs: sync shared context Git history post-commit
* a50f248 docs: log netlify production deploy
* a369319 docs: sync shared context Git history post-commit
* ebaf4d2 feat: close remaining drug map gaps and wire netlify env
* 511d27e chore: track and upgrade map audit/generate scripts
* 5f64969 docs: sync shared context Git history post-commit
* fe2c6ea fix: stabilize drug map workflow with overrides and gap report
* 90e63e8 docs: sync shared context Git history post-commit
* 7a6e616 feat: add age encryption scaffold and stage Patch2 drug data updates
* bc1b00f feat: apply Patch2 EFG updates and add bidirectional span support
* 9bf4ae9 feat: add drug data and user feedback documentation.
* a3cd508 feat: remove unused `test.js` file.
```

## 更新規則

**每位 AI 助手完成工作後，必須更新此檔案：**

### Git 歷史（機械同步）
- 執行 `git log --oneline --graph -15` 並**原樣貼上**到「Git 歷史」區塊
- 純粹反映 repo 狀態，不需人工編輯

### 變更日誌（語義紀錄）
變更日誌的定位是**比 git history 更完整的審計軌跡**，涵蓋所有 AI 操作——不論是否產生 commit。

**必須記錄的情境：**
- 新增/修改/刪除檔案（含 commit hash 如有）
- 設定變更（.env、config 等可能被 gitignore 的檔案）
- 本地操作（git sync、branch merge、環境設定）
- 重要決策或討論結論

**格式：** `[日期] [AI名稱]: 變更摘要`

### 其他區塊
- 新增/修改檔案 → 更新「專案資訊 / 主要內容」等相關區塊

---

## 專案資訊

### 專案說明
台大醫院藥劑部門診配藥訓練遊戲，用於訓練藥師熟悉藥品位置和配藥流程。

### 技術棧
- 純 HTML/CSS/JavaScript 單頁應用
- Netlify 手動部署（`netlify deploy --prod`，非 GitHub 自動連動）

### 主要檔案結構
```
.
├── dispensing-game.html    # 主遊戲檔案
├── admin.html              # 藥品櫃位管理後台
├── drug_data.js             # 共用藥品資料庫 (cabinetConfig + drugDatabase)
├── drug_map.js             # 藥品名稱到照片路徑映射
├── Reference/
│   └── DrugData/Images/    # 145 張藥品照片
└── patch update 0129/      # 位置參考文件 (Word/PDF)
```

### 藥品資料結構
```javascript
{
  name: "藥品名稱",
  cabinet: "A-J 或 Desktop",
  section: "drawer1/drawer2/doorL/doorR" (僅下排櫃),
  row: 1-4,
  col: 1-3,
  stripSize: 一排數量,
  boxSize: 一盒數量 (選填，留白表示未知),
  isBox: true/false (選填),
  unit: "盒/束/包" (選填，自訂包裝單位),
  colSpan: 2 (選填，橫向占用格數),
  rowSpan: 2 (選填，直向占用格數)
}
```

### 參考資源
- NTUH 藥劑部藥品查詢: https://www.ntuh.gov.tw/phr/Fpage.action?muid=2077&fid=1939

---

## 變更日誌

- [2026-02-23] Codex (GPT-5): 依使用者要求嘗試至 NTUH 藥劑部網站查找 `Duxetine` 圖片（shell `curl`、Python `urllib`、Chrome DevTools 與 `http/https` 明細頁入口皆測試），本執行環境對 `reg.ntuh.gov.tw/pharmacyoutside/*` 持續 timeout，尚未取得官方圖片 URL；保留 `Duxetine` 無 mapping 並由前台 fallback 顯示。
- [2026-02-23] Codex (GPT-5): 執行瀏覽器 smoke test（本機 `python3 -m http.server` + Chrome DevTools）驗證 Patch3 目標座標與圖片 fallback；發現 `drug-image-fallback` 的 `hidden` 屬性被 CSS `display:flex` 覆蓋，於 `dispensing-game.html` 加上 `.drug-image-fallback[hidden]{display:none!important;}` 修復。fix commit `2537ab0`。
- [2026-02-23] Codex (GPT-5): 執行 `git fetch --all --prune` 完成遠端同步檢查；`main` 與 `origin/main` 無 ahead/behind（`0/0`），`git branch -r --no-merged main` 無結果。
- [2026-02-23] Codex (GPT-5): 整合 `Patch 3` 的 G/H/I/J（含部分 G 抽屜 2）櫃位/跨格資料到 `drug_data.js`，採保守合併保留既有 `boxSize/isBox/unit` metadata；補 `drug_map.js` 的 `Apa-Mirtazapine` alias；`dispensing-game.html` 新增右手區與放大卡片圖片壞檔/缺圖 fallback（`Vimpat` 等不再顯示破圖 icon）。feature commit `e4b6285`。
- [2026-02-18] Codex (GPT-5): 執行 Netlify production deploy（deploy id: `699555ed7ff88a370f227321`），發布網址 `https://ntuh-pharm-game.netlify.app`，preflight 驗證 `NETLIFY_AUTH_TOKEN` 與 `NETLIFY_SITE_ID` 皆通過。
- [2026-02-18] Codex (GPT-5): 補齊 `drug_map` 缺鍵 10 筆（Abilify/Sinemet/Sinomin/Sirdalud/Takepron/Tetracycline/Userm/Valdoxan/Wecoli/Xarelto），更新 `Reference/DrugData/drug_map.overrides.json`、`drug_map.js`、`drug_map.json` 與 `Reference/DrugData/drug_map_gap_report.md`（缺鍵=0）；自本機 Netlify CLI token 寫入本地 `.env` 生成加密 `.env.age`，`./netlify-preflight.sh` 驗證通過。
- [2026-02-18] Codex (GPT-5): 建立 `Reference/DrugData/drug_map.overrides.json` 與 `Reference/DrugData/drug_map_gap_report.md`，重生 `drug_map.js` / `drug_map.json` 並補齊新命名 alias（如 Carlipin、Amoxicillin 250 mg/cap、Nifedipine S.R.F.C...）；README 補充 mapping 維護流程（generate + audit），新增 `netlify-preflight.sh` 部署前環境變數檢查。
- [2026-02-18] Claude Opus 4.6: git sync + 統一提交 Patch2 drug data 更新、age 加密 scaffold、.gitignore 規則、更新 shared context 格式（分層更新規則）。
- [2026-02-17] Codex (GPT-5): 建立本專案 local env 與 age 加密流程：新增 `secrets/env.keys` allowlist、`.claude/setup.sh`、`.env.age`；更新 `.gitignore` 加入 `.env`/`age-key.txt` 忽略與 `.env.age` 追蹤規則。
- [2026-02-12] Codex (GPT-5): 套用 Patch2 第一輪：更新 E/F/G 櫃位資料（桌面維持 1x5 既有配置）、修正兩組重疊座標造成不可見藥品、補上 `drug_map` 命名 alias（Sandimmun/Stable/Seroquel/Keppra）、新增 `Patch2/缺圖資產清單.md`（Patch2 目標區缺圖 25 筆）、後台與前台新增 `rowSpan` 支援（橫向/直向跨格皆可，1~4）。
- [2026-02-12] Codex (GPT-5): 依新增回饋優化前台 UX：放大視窗卡片顯示藥品圖片、配藥模式錯選也顯示所點藥品照片、左側加入桌面區常備藥、右手區支援雙擊移除暫存藥品、右側顯示當天日期、題數旁新增小型題目計時器（每題秒數）。
- [2026-02-12] Codex (GPT-5): 修正前台 `updateDrugImage()` 缺失造成的 runtime error；配藥題目產生器改為容錯（`boxSize` 缺值不再產生 `NaN/undefined`）；修正 `drug_data.js` 櫃位 config（J/I/H/G 抽屜 5x3、E/F 抽屜 6x3、門 1x2、Desktop 1x5）；後台匯出改為僅在 `boxSize` 有效時輸出，避免 `boxSize: undefined` 汙染資料。
- [2026-02-11] Claude Opus 4.6: 前台遊戲同步 cabinetConfig（B 櫃 7 列、E/F 抽屜 6 列、unit/colSpan 支援）+ 補齊 13 張藥品圖片
- [2026-02-11] Claude Opus 4.6: 套用 Patch1 更新 A/B/C 櫃藥品位置與屬性、更新 drug_map.js 圖片映射、修復後台 saveModal unit/colSpan 儲存邏輯
- [2026-02-09] Claude Opus 4.6: 新增變更歷程追蹤面板與意見回饋欄位，匯出時附帶歷程
- [2026-02-09] Claude Opus 4.6: 移除後台圖片替換功能（localStorage 容量限制）
- [2026-02-09] Claude Opus 4.6: 抽離 drugDatabase 至 drug_data.js，新增 admin.html 後台管理面板
- [2026-02-09] Claude Opus 4.6: 修正配藥換題計數器未歸零、抽屜藥品點擊後觸發選取邏輯
- [2026-02-05] Claude Opus 4.5: 修正 Denosin 與 Doxaben 2mg 藥品照片
- [2026-02-05] Claude Opus 4.5: 新增暫停/重新開始按鈕、修正放大視窗藥物點擊、位置提示自動清除、Eurodin 位置校正 (H1→G1)
